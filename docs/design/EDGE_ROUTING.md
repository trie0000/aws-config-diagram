# エッジルーティング アルゴリズム仕様書 v15.5.0

## 概要

アイコン間の接続線を、水平・垂直セグメントのみで構成される直交パスとしてルーティングする。
グリッドも力学シミュレーションも使わず、ピクセル座標上で候補パスを生成・評価する決定的アルゴリズム。

## 接続線のルール

1. 距離が短い矢印から先にルーティング
2. アイコンの辺から法線ベクトル方向に出る（角には繋げない）
3. 矢印は自身のアイコン・相手のアイコン・途中のアイコンの中を通らない
4. アイコンの縁も通してはいけない
5. 接続線は水平か垂直のいずれかで、斜めは使わない
6. 折り曲がりの数が最小になる経路を選ぶ
7. 同じ曲がり数なら一番距離が短い経路を選ぶ
8. 異なる経路の矢印は交差はOKだが、**重なりはNG**（セグメントの一部でも重複する候補は除外する）
9. 同じアイコンの辺に繋がる経路は重ならない最小間隔(MIN_PORT_GAP=2px)でよい。見栄えの間隔確保はPhase 3/4の後処理で行う
10. 複数経路がある場合、他の経路との交差が最も少ない経路を選ぶ
11. 後戻り（U字パス）や斜め線のある候補は除外する

### ルール優先順位（評価順）

ルール8 = ルール11（絶対除外）> ルール3（ペナルティ最小化）> ルール6 > ルール10 > ルール7 の順。

つまり:
1. **除外**: 重なりあり（ルール8）、パス欠陥あり（ルール11）→ 候補から除外
2. **ペナルティ最小化**: アイコン貫通数（ルール3）→ hits 最小（0が理想だが、5パターンでは回避不可能な場合がある）
3. **評価**: 曲がり最小（ルール6）→ 交差最少（ルール10）→ 距離最短（ルール7）

※ルール8で全候補が除外される場合のみ、フォールバックとして重なり最小の候補を選ぶ。

## パイプライン

```
Phase 0: 準備
  collectIconRects → iconMap
  エッジを距離順ソート（ルール1）

Phase 1: 各エッジのルーティング
  全16通り(4辺×4辺)の組み合わせを試行
  各組み合わせで PortTracker がポート候補位置を生成
  generateCandidatePaths() → 直線/L字/Z字候補
  hasPathDefect() → 後戻り・斜め線フィルター（ルール11）
  countOverlap() → 既存パスとの重なりチェック（ルール8）→ overlap>0 は除外
  スコアリング: hits少 → bends少 → cross少 → len短
  最良候補を選択し、PortTracker に確定登録
  ※ 全候補が重なりで除外された場合はフォールバック（重なり最小）

Phase 2: ポート再割り当て（reassignPorts）
  同一アイコン辺のポート割り当て順列を全探索し交差最小化

Phase 3: ポートグループ中央寄せ（centerPorts）
  同一アイコン辺のポートグループを辺の中央に寄せる
  障害物衝突チェック付き

Phase 4: ポート均等配置（spreadPorts）
  同一アイコン辺のポート群をPORT_GAP間隔で均等に再配置
  直線パス（bends=0）は固定。障害物衝突チェック付き
```

## Phase 1: パス探索

### 用語

- **接続点（srcPt / dstPt）**: アイコン辺面上の座標。パスの始点・終点。PortTracker の offset で辺の中央からずらす。
- **ステム（stem）**: 接続点から法線方向に STEM_LEN(20px) 延伸した点。ここが実質的なルーティングの起点・終点。
- **障害物**: 全アイコン矩形（src/dst 含む）。MARGIN(8px) の余白を含めて判定する。

### パス構造

```
srcPt → srcStem → (中間経路) → dstStem → dstPt
```

srcPt→srcStem と dstStem→dstPt は必ず法線方向の直線（ルール2）。
中間経路は水平・垂直セグメントのみ（ルール5）。

**重要**: countObstacleHits ではstemセグメント（srcPt→srcStem, dstStem→dstPt）をチェック対象から除外する。
stemは必ずアイコン辺面から法線方向に延びるため、自ノードのアイコン内を通過するが、
これは接続の構造上不可避であり、ルール3/4の例外とする。

### ポート候補位置の生成（PortTracker）

PortTracker は各 `(nodeId, side)` に割り当て済みのポート座標を管理し、
新しいエッジのポート位置候補を生成する。

#### 中央→外側（最小間隔）

```
ポートなし → offset = 0（中央）
ポートあり → 外側候補のみ:
  最小の外側: sorted[0] - MIN_PORT_GAP
  最大の外側: sorted[last] + MIN_PORT_GAP
  （アイコン辺からはみ出る場合は候補から除外）
```

MIN_PORT_GAP=2px はルーティング時の仮間隔。見栄えの間隔（PORT_GAP=12px）は
Phase 3/4 の後処理で確保する。

これを **src側・dst側の両方** で生成し、全16辺パターン × src候補 × dst候補 の
全組み合わせから最良を選択する。

交差最適化は PortTracker ではなく、Phase 2 の reassignPorts で後処理として行う。

### 候補パス生成（generateCandidatePaths）

曲がり数が少ない順に候補を生成する:

1. **直線**（0曲がり）: srcStem と dstStem が同一軸上の場合のみ
2. **L字**（1曲がり）: 水平→垂直、垂直→水平 の2通り
3. **Z字**（2曲がり）: 中間点(midX, midY)を用いた2通り

simplify() で同一軸上の冗長な中間点を除去。

### パス欠陥検出（hasPathDefect）

候補パスに以下の欠陥がないか検証する（ルール11）:

1. **斜め線**: 隣接2点のxもyも異なるセグメント
2. **後戻り（U字）**: 同一軸上の連続3点で方向が反転

```
例: (596, 1391) → (601, 1391) → (581, 1391)
     x軸で +5 → -20 と方向反転 = U字 → 除外
```

### 評価

```
nonOverlap = []   // 重なりなし候補
fallback = []     // 重なりあり候補（フォールバック用）

for each candidate:
  if hasPathDefect(path): skip        // ルール11
  overlap = countOverlap(path)        // ルール8
  hits = countObstacleHits(path)      // ルール3
  bends = countBends(path)            // ルール6
  cross = countCrossings(path)        // ルール10
  len = pathLength(path)              // ルール7

  if overlap == 0:
    nonOverlap に追加
  else:
    fallback に追加

// 重なりなし候補がある場合はその中から選択
// なければフォールバックから overlap少 で選択
選択: hits少 → bends少 → cross少 → len短（辞書順）
```

### 重なり判定（countOverlap）

既存パスのセグメントと新候補パスのセグメントが**同方向（水平-水平 or 垂直-垂直）で座標範囲が重複**する場合を重なりとしてカウントする。

```
水平セグメント同士: y座標が同一 かつ x範囲が重複
垂直セグメント同士: x座標が同一 かつ y範囲が重複
```

## Phase 2: ポート再割り当て（reassignPorts）

### 目的

同じアイコン辺に複数エッジが接続されている場合、ポート割り当て順序を入れ替えて交差を最小化する。

### アルゴリズム

1. 全エッジの端点を `nodeId:side` でグルーピング
2. エントリ数2〜5のグループを対象に、ポートoffsetの全順列を試す
3. 各順列でwaypointsをシフトし、交差数を計算
4. 障害物衝突チェック付き（衝突する順列はスキップ）
5. 交差数が最小の順列を採用

## Phase 3: ポートグループ中央寄せ（centerPorts）（ルール9）

### 目的

同じアイコンの同じ辺から出入りする複数エッジのポートグループを、辺の中央に寄せて見栄えを改善する。

### アルゴリズム

1. 全エッジの端点を `nodeId:side` でグルーピング（src/dst 区別なし）
2. グループ内に直線パス（bends=0）がある場合はスキップ（直線は移動不可）
3. グループの座標範囲の中央を計算し、アイコン辺の中央とのずれを算出
4. シフト量をクランプ（ポートがアイコン辺を超えないように）
5. **安全性チェック**: テストコピーにシフトを適用し、障害物衝突がないか確認
6. 安全なら全エントリにシフトを適用

### applyShift

ポート点、stem点、およびstemと同軸のエルボー点をまとめて移動:

```
src端 (left/right): wp[0].y, wp[1].y, (wp[2].y if collinear) をシフト
src端 (top/bottom): wp[0].x, wp[1].x, (wp[2].x if collinear) をシフト
dst端: 末尾から同様
```

## 定数一覧

| 定数 | ファイル | 値 | 意味 |
|------|---------|-----|------|
| MARGIN | edgeRouter.bfs.ts | 8px | 障害物回避マージン |
| STEM_LEN | edgeRouter.bfs.ts | 20px | 法線方向のステム長 |
| MIN_PORT_GAP | edgeRouter.ts | 2px | Phase 1 でのポート最小間隔（重なり防止） |
| PORT_GAP | edgeRouter.ts | 12px | Phase 3/4 でのポート見栄え間隔 |

## ファイル構成

| ファイル | 責務 |
|---------|------|
| `edgeRouter.types.ts` | 型定義、定数、bestSides、nodeIconRect |
| `edgeRouter.bfs.ts` | 候補パス生成（直線/L字/Z字）、スコアリングユーティリティ |
| `edgeRouter.ts` | オーケストレータ（routeAllEdges、PortTracker、centerPorts、spreadPorts） |
| `EdgeLine.tsx` | 描画（waypoints → SVG path） |

## 描画

### 矢印マーカー

| id | サイズ | 用途 |
|----|-------|------|
| `arrowhead` | 8×6 px | 通常表示 |
| `arrowhead-lg` | 16×12 px | ハイライト表示 |

### 線のスタイル

| type | stroke | dash | 用途 |
|------|--------|------|------|
| `data-flow` | `#94a3b8` (slate-400) | 実線 | SG ルールベース通信パス |
| その他 | `#cbd5e1` (slate-300) | `6 3` 破線 | 関連接続 |

| 状態 | strokeWidth |
|------|------------|
| 通常 | 1.5 px |
| ハイライト | 3.5 px |

## Phase 4: ポート均等配置（spreadPorts）

### 目的

Phase 1 で MIN_PORT_GAP=2px の密集間隔で配置されたポート群を、PORT_GAP=12px の見栄え間隔で均等に再配置する。
ポート点（wp[0], wp[last]）自体を動かし、applyShift でstem・エルボーも連動させる。

### アルゴリズム

各アイコンの各辺ごとに以下を実行:

1. 辺に接続された全ポートを offset 順にソートする
2. **固定ポートの判定**: 曲がり角がない接続線（bends=0、直線パス）は固定とし、動かさない
3. **両端の外側ポート配置**: 一番外側のポートをアイコン隅からアイコン辺長の10%離れた位置に設定する
4. **区間ごとの等間隔配置**:
   - 固定ポートが存在しない場合: 両端を固定し、その間のポートを等間隔に配置
   - 固定ポートが1本の場合: 外側端〜固定ポート間のポートを等間隔に配置
   - 固定ポートが2本以上の場合: 各固定ポート間のポートも同様に等間隔に配置
5. **障害物衝突チェック**: シフト後に障害物に衝突する場合はスキップ

### 具体例

```
アイコン bottom辺（幅36px, halfEdge=16px）にポート4本:
  Phase 1 後: offset = [-4, -2, 0, +2]（MIN_PORT_GAP=2px間隔）
  全て曲がり角あり（固定なし）
  edgeMargin = 36 × 10% = 3.6px

  1. 左端を -halfEdge + margin = -16 + 3.6 = -12.4 に設定
  2. 右端を +halfEdge - margin = +16 - 3.6 = +12.4 に設定
  3. 間の2本を [-12.4, +12.4] の間に等間隔: -12.4, -4.1, +4.1, +12.4
```

```
固定ポート（直線パス）が1本ある場合:
  offset = [-2, 0(固定), +2, +4]
  edgeMargin = 3.6px

  1. 左端を -12.4 に設定
  2. 右端を +12.4 に設定
  3. 区間[-12.4, 0]: 間の1本(-2) → -6.2 に配置
  4. 区間[0, +12.4]: 間の1本(+2) → +6.2 に配置
```

## 変更履歴

### v15.5.0

| 項目 | v15.4.0 | v15.5.0 | 理由 |
|------|---------|---------|------|
| Phase 4 | alignElbows（エルボー座標をPORT_GAP間隔に整列） | **spreadPorts（ポート点自体をPORT_GAP間隔で均等配置）** | 旧 alignElbows はエルボーのみ動かしポート点は密集のまま。spreadPorts はポート点を直接動かし見栄えを改善 |

### v15.4.0

| 項目 | v15.3.0 | v15.4.0 | 理由 |
|------|---------|---------|------|
| PortTracker 間隔 | PORT_GAP=12px | **MIN_PORT_GAP=2px** | Phase 1 では最小間隔で十分。12px 間隔だとアイコン辺がすぐ埋まり、別の辺に追い出されて交差が発生する |

### v15.3.0

| 項目 | v15.2.0 | v15.3.0 | 理由 |
|------|---------|---------|------|
| 重なり除外 | なし | **countOverlap() で既存パスとの重なりを検出、重なりあり候補を除外** | ルール8の実装 |
| ポート候補 | 外側 + 隙間候補 | **外側候補のみ（隙間候補廃止）** | reassignPorts で後処理として交差最適化 |
| 後処理 | centerPorts のみ | **reassignPorts → centerPorts → alignElbows** | 交差最小化 + エルボー整列 |

### v15.2.0

| 項目 | v15.1.0 | v15.2.0 | 理由 |
|------|---------|---------|------|
| ポート候補 | 外側2候補のみ | 外側 + 既存ポート間の隙間候補 | 既存線の間を通る交差回避ルートを探索可能にする |
| 候補生成 | peekOffsets(正/反転) | peekOffsets(外側 + 隙間) | src・dst両方で全組み合わせを試行 |

### v15.1.0

| 項目 | 変更内容 |
|------|---------|
| hasPathDefect | 初期ルーティングで後戻り（U字）・斜め線のある候補を除外するフィルター追加 |

### v15.0.0

| 項目 | 変更内容 |
|------|---------|
| アルゴリズム全面再設計 | 距離順グリーディ + 全16辺パターン + PortTracker双方向offset |
| centerPorts | ポートグループをアイコン辺の中央に寄せるポスト処理 |
