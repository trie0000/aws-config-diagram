# エッジルーティング アルゴリズム仕様書 v15.2.0

## 概要

アイコン間の接続線を、水平・垂直セグメントのみで構成される直交パスとしてルーティングする。
グリッドも力学シミュレーションも使わず、ピクセル座標上で候補パスを生成・評価する決定的アルゴリズム。

## 接続線のルール

1. 距離が短い矢印から先にルーティング
2. アイコンの辺から法線ベクトル方向に出る（角には繋げない）
3. 矢印は自身のアイコン・相手のアイコン・途中のアイコンの中を通らない
4. アイコンの縁も通してはいけない
5. 接続線は水平か垂直のいずれかで、斜めは使わない
6. 折り曲がりの数が最小になる経路を選ぶ
7. 同じ曲がり数なら一番距離が短い経路を選ぶ
8. 異なる経路の矢印は交差はOKだが、重なりはNG
9. 同じアイコンの辺に繋がる経路は最低限の間隔(PORT_GAP=12px)が空いていればOK
10. 複数経路がある場合、他の経路との交差が最も少ない経路を選ぶ
11. 後戻り（U字パス）や斜め線のある候補は除外する

### ルール優先順位（評価順）

ルール3 > ルール11 > ルール6 > ルール10 > ルール7 の順。
つまり: アイコン貫通なし → パス欠陥なし → 曲がり最小 → 交差最少 → 距離最短。

## パイプライン

```
Phase 0: 準備
  collectIconRects → iconMap
  エッジを距離順ソート（ルール1）

Phase 1: 各エッジのルーティング
  全16通り(4辺×4辺)の組み合わせを試行
  各組み合わせで PortTracker がポート候補位置を生成
  generateCandidatePaths() → 直線/L字/Z字候補
  hasPathDefect() → 後戻り・斜め線フィルター（ルール11）
  スコアリング: hits少 → bends少 → cross少 → len短
  最良候補を選択し、PortTracker に確定登録

Phase 2: ポートグループ中央寄せ（centerPorts）
  同一アイコン辺のポートグループを辺の中央に寄せる
  障害物衝突チェック付き
```

## Phase 1: パス探索

### 用語

- **接続点（srcPt / dstPt）**: アイコン辺面上の座標。パスの始点・終点。PortTracker の offset で辺の中央からずらす。
- **ステム（stem）**: 接続点から法線方向に STEM_LEN(20px) 延伸した点。ここが実質的なルーティングの起点・終点。
- **障害物**: 全アイコン矩形（src/dst 含む）。MARGIN(8px) の余白を含めて判定する。

### パス構造

```
srcPt → srcStem → (中間経路) → dstStem → dstPt
```

srcPt→srcStem と dstStem→dstPt は必ず法線方向の直線（ルール2）。
中間経路は水平・垂直セグメントのみ（ルール5）。

**重要**: countObstacleHits ではstemセグメント（srcPt→srcStem, dstStem→dstPt）をチェック対象から除外する。
stemは必ずアイコン辺面から法線方向に延びるため、自ノードのアイコン内を通過するが、
これは接続の構造上不可避であり、ルール3/4の例外とする。

### ポート候補位置の生成（PortTracker）

PortTracker は各 `(nodeId, side)` に割り当て済みのポート数を管理し、
新しいエッジのポート位置候補を生成する。

#### 現行（v15.1.0）: 外側交互配置

中央から外側へ交互に振る:

```
n=0 → offset = 0         （中央）
n=1 → offset = -PORT_GAP  （中央の左/上）
n=2 → offset = +PORT_GAP  （中央の右/下）
n=3 → offset = -2×PORT_GAP
...
```

peekOffsets() は正・反転の2候補を返し、両方試す。

**問題点**: 既存ポートの外側にしか新しいポートを配置できないため、
既存の線の間を通せば交差を避けられるケースでも、外側に配置して交差が発生する。

#### 新仕様（v15.2.0）: 隙間挿入候補の追加

既存ポートの外側だけでなく、**既存ポート間の隙間**にも候補を生成する。

```
例: ALBの下辺に既存ポート [-12, 0, +12] がある場合

候補一覧:
  -24      （外側: 左端の外）
  -6       （隙間: -12 と 0 の中間）
  +6       （隙間: 0 と +12 の中間）
  +24      （外側: 右端の外）
```

**アルゴリズム**:

1. 対象辺の既存ポート座標リストを取得し、ソートする
2. **外側候補**: 現行と同じく次の空きスロット（正・反転）
3. **隙間候補**: 隣り合う既存ポートの中間点を計算
   - 隙間が PORT_GAP 未満の場合はスキップ（狭すぎる）
4. 全候補を返す

これを **src側・dst側の両方** で生成し、全16辺パターン × src候補 × dst候補 の
全組み合わせから最良を選択する。

### 候補パス生成（generateCandidatePaths）

曲がり数が少ない順に候補を生成する:

1. **直線**（0曲がり）: srcStem と dstStem が同一軸上の場合のみ
2. **L字**（1曲がり）: 水平→垂直、垂直→水平 の2通り
3. **Z字**（2曲がり）: 中間点(midX, midY)を用いた2通り

simplify() で同一軸上の冗長な中間点を除去。

### パス欠陥検出（hasPathDefect）

候補パスに以下の欠陥がないか検証する（ルール11）:

1. **斜め線**: 隣接2点のxもyも異なるセグメント
2. **後戻り（U字）**: 同一軸上の連続3点で方向が反転

```
例: (596, 1391) → (601, 1391) → (581, 1391)
     x軸で +5 → -20 と方向反転 = U字 → 除外
```

### 評価

```
for each candidate:
  if hasPathDefect(path): skip     // ルール11
  hits = countObstacleHits(path)   // ルール3
  bends = countBends(path)         // ルール6
  cross = countCrossings(path)     // ルール10
  len = pathLength(path)           // ルール7

  選択: hits少 → bends少 → cross少 → len短（辞書順）
```

## Phase 2: ポートグループ中央寄せ（centerPorts）

### 目的

同じアイコンの同じ辺から出入りする複数エッジのポートグループを、辺の中央に寄せて見栄えを改善する。

### アルゴリズム

1. 全エッジの端点を `nodeId:side` でグルーピング（src/dst 区別なし）
2. グループ内に直線パス（bends=0）がある場合はスキップ（直線は移動不可）
3. グループの座標範囲の中央を計算し、アイコン辺の中央とのずれを算出
4. シフト量をクランプ（ポートがアイコン辺を超えないように）
5. **安全性チェック**: テストコピーにシフトを適用し、障害物衝突がないか確認
6. 安全なら全エントリにシフトを適用

### applyShift

ポート点、stem点、およびstemと同軸のエルボー点をまとめて移動:

```
src端 (left/right): wp[0].y, wp[1].y, (wp[2].y if collinear) をシフト
src端 (top/bottom): wp[0].x, wp[1].x, (wp[2].x if collinear) をシフト
dst端: 末尾から同様
```

## 定数一覧

| 定数 | ファイル | 値 | 意味 |
|------|---------|-----|------|
| MARGIN | edgeRouter.bfs.ts | 8px | 障害物回避マージン |
| STEM_LEN | edgeRouter.bfs.ts | 20px | 法線方向のステム長 |
| PORT_GAP | edgeRouter.ts | 12px | ポート間の間隔 |

## ファイル構成

| ファイル | 責務 |
|---------|------|
| `edgeRouter.types.ts` | 型定義、定数、bestSides、nodeIconRect |
| `edgeRouter.bfs.ts` | 候補パス生成（直線/L字/Z字）、スコアリングユーティリティ |
| `edgeRouter.ts` | オーケストレータ（routeAllEdges、PortTracker、centerPorts） |
| `EdgeLine.tsx` | 描画（waypoints → SVG path） |

## 描画

### 矢印マーカー

| id | サイズ | 用途 |
|----|-------|------|
| `arrowhead` | 8×6 px | 通常表示 |
| `arrowhead-lg` | 16×12 px | ハイライト表示 |

### 線のスタイル

| type | stroke | dash | 用途 |
|------|--------|------|------|
| `data-flow` | `#94a3b8` (slate-400) | 実線 | SG ルールベース通信パス |
| その他 | `#cbd5e1` (slate-300) | `6 3` 破線 | 関連接続 |

| 状態 | strokeWidth |
|------|------------|
| 通常 | 1.5 px |
| ハイライト | 3.5 px |

## 変更履歴

### v15.2.0（予定）

| 項目 | v15.1.0 | v15.2.0 | 理由 |
|------|---------|---------|------|
| ポート候補 | 外側2候補のみ | **外側 + 既存ポート間の隙間候補** | 既存線の間を通る交差回避ルートを探索可能にする |
| 候補生成 | peekOffsets(正/反転) | **peekOffsets(外側 + 隙間)** | src・dst両方で全組み合わせを試行 |

### v15.1.0

| 項目 | 変更内容 |
|------|---------|
| hasPathDefect | 初期ルーティングで後戻り（U字）・斜め線のある候補を除外するフィルター追加 |

### v15.0.0

| 項目 | 変更内容 |
|------|---------|
| アルゴリズム全面再設計 | 距離順グリーディ + 全16辺パターン + PortTracker双方向offset |
| centerPorts | ポートグループをアイコン辺の中央に寄せるポスト処理 |
